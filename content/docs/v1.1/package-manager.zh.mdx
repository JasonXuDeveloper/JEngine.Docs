---
title: 包管理
description: 强大的热更包管理功能，支持主包和分包独立管理
icon: Package
---

JEngine 提供了强大的热更包管理功能，支持主包和分包的独立管理和更新。

## 包类型介绍

### 主包（Main Package）
- 包含热更代码和核心资源
- 必须首先加载
- 默认名称：`main`
- **该包是YooAsset的默认包**，即使用YooAsset的函数是如果未指定分包就会用主包

### 分包（Sub Packages）
- 包含额外的资源
- 按需加载
- 可独立更新
- 示例：`AddOn1`、`Raw`

## 资源包配置

### YooAsset 配置
在 Unity 编辑器中配置资源包：
1. 打开 `YooAsset/AssetBundle Collector`
2. 配置不同的包和资源规则
3. 设置打包策略

### 资源组织结构

<Files>
  <Folder name="Assets/HotUpdate" defaultOpen>
    <Folder name="Main（主包资源）" defaultOpen>
      <Folder name="Prefabs" />
      <Folder name="Scenes" />
      <Folder name="UI" />
    </Folder>
    <Folder name="AddOn1（分包1）" />
    <Folder name="Code（自动包含在主包）" />
  </Folder>
</Files>

## 包版本管理

### 版本号生成
每次构建会自动生成基于时间戳的版本号：
- 格式：`年月日时分秒` （如：24120115300）
- 生成算法：`(year-2000)*10000000 + month*100000 + day*1000 + hour*100 + minute*10 + second/6`
- 确保每次构建的版本号都不同

### 版本文件结构

<Files>
  <Folder name="Bundles" defaultOpen>
    <Folder name="WebGL（平台）" defaultOpen>
      <Folder name="main（包名）" defaultOpen>
        <Folder name="24120115300（版本1）" />
        <Folder name="24120115400（版本2）" />
      </Folder>
    </Folder>
  </Folder>
</Files>

## Bootstrap API

所有包管理方法都是 `Bootstrap` 类中的静态方法。

### CreateOrGetPackage

创建或获取资源包实例，用于管理热更新资源分包。

```csharp
public static ResourcePackage CreateOrGetPackage(string packageName)
```

**参数说明：**
- `packageName` - 资源包名称（如 "main", "AddOn1"）

**返回值：**
- `ResourcePackage` - YooAsset 资源包实例

**使用示例：**
```csharp
// 创建或获取资源包
var package = Bootstrap.CreateOrGetPackage("AddOn1");
```

### UpdatePackage

检查并更新指定的资源包，包括版本检查、资源下载和初始化过程。

```csharp
public static async UniTask<bool> UpdatePackage(ResourcePackage package, PackageInitializationCallbacks callbacks, EncryptionOption encryptionOption)
```

**参数说明：**
- `package` - 要更新的资源包实例
- `callbacks` - 包初始化回调结构体
- `encryptionOption` - 加密选项（Xor/Aes/ChaCha20）

**返回值：**
- `UniTask<bool>` - 更新是否成功

**PackageInitializationCallbacks 回调参数：**
- `OnStatusUpdate` - `Action<PackageInitializationStatus>` - 状态更新回调
- `OnVersionUpdate` - `Action<string>` - 版本信息回调
- `OnDownloadProgress` - `DownloaderOperation.DownloadUpdate` - 下载进度回调
- `OnDownloadPrompt` - `Func<int, long, UniTask<bool>>` - 下载确认回调
- `OnDownloadStart` - `Action` - 下载开始回调
- `OnDownloadComplete` - `Action` - 下载完成回调
- `OnError` - `Func<Exception, UniTask>` - 错误处理回调

**使用示例：**
```csharp
// 配置回调
var callbacks = new PackageInitializationCallbacks
{
    OnStatusUpdate = (status) => {
        Debug.Log($"包初始化状态: {status}");
    },
    OnVersionUpdate = (version) => {
        Debug.Log($"版本信息: {version}");
    },
    OnDownloadProgress = (downloaded, total, progress) => {
        Debug.Log($"下载进度: {progress * 100:F1}%");
    },
    OnDownloadPrompt = async (fileCount, totalBytes) => {
        Debug.Log($"需要下载 {fileCount} 个文件，总大小: {totalBytes} bytes");
        return true; // 确认下载
    },
    OnDownloadStart = () => {
        Debug.Log("开始下载");
    },
    OnDownloadComplete = () => {
        Debug.Log("下载完成");
    },
    OnError = async (exception) => {
        Debug.LogError($"错误: {exception.Message}");
    }
};

// 更新资源包
bool success = await Bootstrap.UpdatePackage(
    package,                     // ResourcePackage 实例
    callbacks,                   // 回调
    EncryptionOption.Xor         // 加密选项
);
```

### LoadHotUpdateScene

从指定的资源包中异步加载热更新场景。

```csharp
public static async UniTask<SceneHandle> LoadHotUpdateScene(ResourcePackage package, string sceneName, SceneLoadCallbacks callbacks, LoadSceneMode loadMode = LoadSceneMode.Single)
```

**参数说明：**
- `package` - 资源包实例
- `sceneName` - 场景名称
- `callbacks` - 场景加载回调结构体
- `loadMode` - 加载模式（默认 Single）

**返回值：**
- `UniTask<SceneHandle>` - YooAsset 场景句柄

**SceneLoadCallbacks 回调参数：**
- `OnStatusUpdate` - `Action<SceneLoadStatus>` - 场景加载状态回调
- `OnProgressUpdate` - `Action<float>` - 加载进度回调 (0.0-1.0)
- `OnError` - `Func<Exception, UniTask>` - 错误处理回调

**使用示例：**
```csharp
// 配置场景加载回调
var sceneCallbacks = new SceneLoadCallbacks
{
    OnProgressUpdate = (progress) => {
        Debug.Log($"场景加载进度: {progress * 100:F1}%");
    },
    OnStatusUpdate = (status) => {
        Debug.Log($"场景加载状态: {status}");
    },
    OnError = async (exception) => {
        Debug.LogError($"场景加载错误: {exception.Message}");
    }
};

// 加载热更场景
var mainPackage = Bootstrap.CreateOrGetPackage("main");
SceneHandle sceneHandle = await Bootstrap.LoadHotUpdateScene(
    mainPackage,                 // ResourcePackage 实例
    "GameScene",                 // 场景名称
    sceneCallbacks,              // 回调
    LoadSceneMode.Single         // 加载模式
);
```

### DeletePackageCache

删除指定资源包的本地缓存文件。

```csharp
public static async UniTask<bool> DeletePackageCache(ResourcePackage package, Func<Exception, UniTask> onError = null)
```

**参数说明：**
- `package` - 要清理缓存的资源包实例
- `onError` - 错误处理回调（可选）

**返回值：**
- `UniTask<bool>` - 清理是否成功

**使用示例：**
```csharp
// 清理指定包缓存
var package = Bootstrap.CreateOrGetPackage("AddOn1");
bool deleted = await Bootstrap.DeletePackageCache(
    package,
    onError: async (exception) => {
        Debug.LogError($"清理缓存失败: {exception.Message}");
    }
);

// 清理主包缓存
var mainPackage = Bootstrap.CreateOrGetPackage("main");
bool success = await Bootstrap.DeletePackageCache(mainPackage);
```

## 资源加载

资源加载请参考 [YooAsset 官方文档](https://www.yooasset.com/docs/Introduce) 了解详细的资源加载 API 和使用方法。

JEngine 使用 YooAsset 作为资源管理系统，支持同步和异步加载、资源引用计数、内存管理等功能。


## 缓存管理

### 缓存位置

<Tabs items={['编辑器', 'Android', 'iOS', 'Windows']}>
<Tab value="编辑器">`UnityProject/yoo/`</Tab>
<Tab value="Android">`Application.persistentDataPath/yoo/`</Tab>
<Tab value="iOS">`Application.persistentDataPath/yoo/`</Tab>
<Tab value="Windows">`Application.persistentDataPath/yoo/`</Tab>
</Tabs>

### 加密选项

<Tabs items={['XOR', 'AES', 'ChaCha20']}>
<Tab value="XOR">`EncryptionOption.Xor` — 轻量级，速度快。推荐大多数场景使用。</Tab>
<Tab value="AES">`EncryptionOption.Aes` — 安全性与性能兼顾。</Tab>
<Tab value="ChaCha20">`EncryptionOption.ChaCha20` — 最高安全性。</Tab>
</Tabs>

### 增量更新
只下载变化的文件：
- YooAsset 自动处理增量下载
- 减少下载量和时间



## 最佳实践

<Accordions>
<Accordion title="包划分原则">
- **主包**：核心功能和常用资源
- **分包**：可选功能和大型资源
- 按功能模块划分，便于独立更新
</Accordion>

<Accordion title="版本控制">
- 使用时间戳版本号系统
- 保留历史版本供回滚
- 记录版本更新日志
</Accordion>

<Accordion title="性能优化">
- 使用 CDN 加速下载
- 启用资源压缩
- 合理控制包大小
</Accordion>
</Accordions>

<Callout type="warn" title="注意事项">
- 主包必须包含所有热更代码
- 分包不能包含代码，只能包含资源
- 合理控制包大小（建议单包不超过 50MB）
- 定期清理旧版本缓存
- 服务器需支持断点续传
</Callout>